From 4c30c5e4fdac32f5e27cf7fff544fec79aa05b31 Mon Sep 17 00:00:00 2001
From: Nikhil Sonti <nikhilsv92@gmail.com>
Date: Mon, 16 Jun 2025 14:14:40 -0700
Subject: [PATCH] nxtscape updater with sparkle

---
 chrome/BUILD.gn                               |   5 +
 chrome/browser/BUILD.gn                       |  20 ++
 .../mac/chrome_browser_main_extra_parts_mac.h |   1 +
 .../chrome_browser_main_extra_parts_mac.mm    |  12 +
 chrome/browser/mac/sparkle_glue.h             |  46 +++
 chrome/browser/mac/sparkle_glue.mm            | 262 ++++++++++++++++++
 chrome/browser/mac/su_updater.h               |  38 +++
 chrome/browser/sparkle_buildflags.gni         |  21 ++
 chrome/browser/ui/BUILD.gn                    |   3 +
 .../webui/help/sparkle_version_updater_mac.h  |  50 ++++
 .../webui/help/sparkle_version_updater_mac.mm |  89 ++++++
 .../ui/webui/help/version_updater_mac.mm      |  48 +++-
 third_party/sparkle/BUILD.gn                  |  50 ++++
 13 files changed, 644 insertions(+), 1 deletion(-)
 create mode 100644 chrome/browser/mac/sparkle_glue.h
 create mode 100644 chrome/browser/mac/sparkle_glue.mm
 create mode 100644 chrome/browser/mac/su_updater.h
 create mode 100644 chrome/browser/sparkle_buildflags.gni
 create mode 100644 chrome/browser/ui/webui/help/sparkle_version_updater_mac.h
 create mode 100644 chrome/browser/ui/webui/help/sparkle_version_updater_mac.mm
 create mode 100644 third_party/sparkle/BUILD.gn

diff --git a/chrome/BUILD.gn b/chrome/BUILD.gn
index 97f843f8133c4..a8318812dcdc3 100644
--- a/chrome/BUILD.gn
+++ b/chrome/BUILD.gn
@@ -18,6 +18,7 @@ import("//build/config/win/manifest.gni")
 import("//build/private_code_test/private_code_test.gni")
 import("//build/toolchain/toolchain.gni")
 import("//chrome/browser/buildflags.gni")
+import("//chrome/browser/sparkle_buildflags.gni")
 import("//chrome/chrome_paks.gni")
 import("//chrome/common/features.gni")
 import("//chrome/process_version_rc_template.gni")
@@ -1218,6 +1219,10 @@ if (is_win) {
       bundle_deps += [ ":preinstalled_apps" ]
     }
 
+    if (enable_sparkle) {
+      bundle_deps += [ "//third_party/sparkle:sparkle" ]
+    }
+
     configs += [ ":chrome_dll_symbol_order" ]
     if (!is_component_build && !using_sanitizer) {
       configs += [ ":chrome_dll_symbol_exports" ]
diff --git a/chrome/browser/BUILD.gn b/chrome/browser/BUILD.gn
index ad39862fdd9a5..8cadfe3c6e7fb 100644
--- a/chrome/browser/BUILD.gn
+++ b/chrome/browser/BUILD.gn
@@ -12,6 +12,7 @@ import("//build/config/features.gni")
 import("//build/config/python.gni")
 import("//build/config/ui.gni")
 import("//chrome/browser/buildflags.gni")
+import("//chrome/browser/sparkle_buildflags.gni")
 import("//chrome/browser/downgrade/buildflags.gni")
 import("//chrome/browser/request_header_integrity/buildflags.gni")
 import("//chrome/common/features.gni")
@@ -119,6 +120,11 @@ buildflag_header("buildflags") {
   }
 }
 
+buildflag_header("sparkle_buildflags") {
+  header = "sparkle_buildflags.h"
+  flags = [ "ENABLE_SPARKLE=$enable_sparkle" ]
+}
+
 source_set("browser_process") {
   sources = [
     "browser_process.cc",
@@ -6557,6 +6563,20 @@ static_library("browser") {
     ]
   }
 
+  if (is_mac && enable_sparkle) {
+    sources += [
+      "mac/sparkle_glue.h",
+      "mac/sparkle_glue.mm",
+      "mac/su_updater.h",
+    ]
+
+    # Add dependency on sparkle buildflags and framework
+    deps += [
+      ":sparkle_buildflags",
+      "//third_party/sparkle:sparkle_framework",
+    ]
+  }
+
   if (is_android || is_mac || is_win || is_chromeos) {
     sources += [
       "device_reauth/chrome_device_authenticator_factory.cc",
diff --git a/chrome/browser/mac/chrome_browser_main_extra_parts_mac.h b/chrome/browser/mac/chrome_browser_main_extra_parts_mac.h
index 95726e7765367..da1f407aff2b3 100644
--- a/chrome/browser/mac/chrome_browser_main_extra_parts_mac.h
+++ b/chrome/browser/mac/chrome_browser_main_extra_parts_mac.h
@@ -24,6 +24,7 @@ class ChromeBrowserMainExtraPartsMac : public ChromeBrowserMainExtraParts {
 
   // ChromeBrowserMainExtraParts:
   void PreEarlyInitialization() override;
+  void PreCreateMainMessageLoop() override;
 
  private:
   std::unique_ptr<display::ScopedNativeScreen> screen_;
diff --git a/chrome/browser/mac/chrome_browser_main_extra_parts_mac.mm b/chrome/browser/mac/chrome_browser_main_extra_parts_mac.mm
index 6bb5ccb823895..48bc86ca53bea 100644
--- a/chrome/browser/mac/chrome_browser_main_extra_parts_mac.mm
+++ b/chrome/browser/mac/chrome_browser_main_extra_parts_mac.mm
@@ -4,11 +4,23 @@
 
 #include "chrome/browser/mac/chrome_browser_main_extra_parts_mac.h"
 
+#include "chrome/browser/sparkle_buildflags.h"
 #include "ui/display/screen.h"
 
+#if BUILDFLAG(ENABLE_SPARKLE)
+#include "chrome/browser/mac/sparkle_glue.h"
+#endif
+
 ChromeBrowserMainExtraPartsMac::ChromeBrowserMainExtraPartsMac() = default;
 ChromeBrowserMainExtraPartsMac::~ChromeBrowserMainExtraPartsMac() = default;
 
 void ChromeBrowserMainExtraPartsMac::PreEarlyInitialization() {
   screen_ = std::make_unique<display::ScopedNativeScreen>();
 }
+
+void ChromeBrowserMainExtraPartsMac::PreCreateMainMessageLoop() {
+#if BUILDFLAG(ENABLE_SPARKLE)
+  // Initialize Sparkle updater if available
+  [[SparkleGlue sharedSparkleGlue] registerWithSparkle];
+#endif
+}
diff --git a/chrome/browser/mac/sparkle_glue.h b/chrome/browser/mac/sparkle_glue.h
new file mode 100644
index 0000000000000..66beee4a4e3cc
--- /dev/null
+++ b/chrome/browser/mac/sparkle_glue.h
@@ -0,0 +1,46 @@
+// Copyright 2024 Nxtscape Browser Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#ifndef CHROME_BROWSER_MAC_SPARKLE_GLUE_H_
+#define CHROME_BROWSER_MAC_SPARKLE_GLUE_H_
+
+#import <Foundation/Foundation.h>
+
+// Forward declarations for C++ types in Objective-C context
+#ifdef __cplusplus
+class SparkleVersionUpdater;
+#else
+typedef struct SparkleVersionUpdater SparkleVersionUpdater;
+#endif
+
+// Simple updater status for Sparkle integration
+enum UpdaterStatus {
+  kUpdaterStatusIdle = 0,
+  kUpdaterStatusChecking = 1,
+  kUpdaterStatusUpdateAvailable = 2,
+  kUpdaterStatusDownloading = 3,
+  kUpdaterStatusReadyToInstall = 4,
+  kUpdaterStatusError = 5,
+};
+
+@interface SparkleGlue : NSObject
+
++ (instancetype)sharedSparkleGlue;
+
+- (void)registerWithSparkle;
+- (void)checkForUpdates;
+- (BOOL)isUpdateCheckEnabled;
+
+// Set the version updater to receive status notifications
+- (void)setVersionUpdater:(SparkleVersionUpdater*)updater;
+
+@end  // @interface SparkleGlue
+
+namespace sparkle_glue {
+
+bool SparkleEnabled();
+
+}  // namespace sparkle_glue
+
+#endif  // CHROME_BROWSER_MAC_SPARKLE_GLUE_H_
\ No newline at end of file
diff --git a/chrome/browser/mac/sparkle_glue.mm b/chrome/browser/mac/sparkle_glue.mm
new file mode 100644
index 0000000000000..3480f03c47075
--- /dev/null
+++ b/chrome/browser/mac/sparkle_glue.mm
@@ -0,0 +1,262 @@
+// Copyright 2024 Nxtscape Browser Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#import "chrome/browser/mac/sparkle_glue.h"
+
+#include <sys/mount.h>
+#include <sys/stat.h>
+
+#include "base/apple/bundle_locations.h"
+#include "base/apple/foundation_util.h"
+#include "base/apple/scoped_nsautorelease_pool.h"
+#include "base/command_line.h"
+#include "base/logging.h"
+#include "base/memory/raw_ptr.h"
+#include "base/strings/sys_string_conversions.h"
+#include "chrome/browser/mac/su_updater.h"
+#include "chrome/browser/ui/webui/help/sparkle_version_updater_mac.h"
+#include "chrome/common/chrome_switches.h"
+
+#if !defined(__has_feature) || !__has_feature(objc_arc)
+#error "This file requires ARC support."
+#endif
+
+namespace {
+
+// Check for updates every 3 hours
+constexpr NSTimeInterval kUpdateCheckIntervalInSec = 3 * 60 * 60;
+
+// Default update feed URL - replace with your actual update server
+NSString* GetUpdateFeedURL() {
+  // You can override with command line flag: --update-feed-url=<url>
+  auto* command_line = base::CommandLine::ForCurrentProcess();
+  if (command_line->HasSwitch("update-feed-url")) {
+    return base::SysUTF8ToNSString(
+        command_line->GetSwitchValueASCII("update-feed-url"));
+  }
+
+  // Default URL - replace with your actual update server
+  return @"https://nxtscape.github.io/nxtscape/appcast.xml";
+}
+
+}  // namespace
+
+@implementation SparkleGlue {
+  SUUpdater* __strong _updater;
+  BOOL _registered;
+  NSString* __strong _appPath;
+  raw_ptr<SparkleVersionUpdater> _versionUpdater;  // Weak reference
+}
+
++ (instancetype)sharedSparkleGlue {
+  static SparkleGlue* shared = nil;
+  static dispatch_once_t onceToken;
+
+  dispatch_once(&onceToken, ^{
+    VLOG(0) << "SparkleGlue: Initializing Sparkle updater";
+
+    // Check if updates are disabled via command line
+    auto* command_line = base::CommandLine::ForCurrentProcess();
+    if (command_line->HasSwitch("disable-updates")) {
+      VLOG(0) << "SparkleGlue: Updates disabled via command line";
+      return;
+    }
+
+    VLOG(0) << "SparkleGlue: Creating SparkleGlue instance";
+    shared = [[SparkleGlue alloc] init];
+    if (![shared loadSparkleFramework]) {
+      VLOG(0) << "SparkleGlue: Failed to load Sparkle framework";
+      shared = nil;
+    } else {
+      VLOG(0) << "SparkleGlue: Successfully loaded Sparkle framework";
+      // Automatically register with Sparkle on successful initialization
+      [shared registerWithSparkle];
+    }
+  });
+
+  return shared;
+}
+
+- (instancetype)init {
+  if (self = [super init]) {
+    _registered = NO;
+    _appPath = [base::apple::OuterBundle().bundlePath copy];
+    return self;
+  }
+  return nil;
+}
+
+- (BOOL)loadSparkleFramework {
+  VLOG(0) << "SparkleGlue: Loading Sparkle framework";
+
+  // Check if running from read-only filesystem (e.g., DMG)
+  if ([self isOnReadOnlyFilesystem]) {
+    VLOG(0) << "SparkleGlue: Running from read-only filesystem, updates disabled";
+    return NO;
+  }
+
+  // Load Sparkle framework
+  NSString* sparkle_path =
+      [[base::apple::FrameworkBundle() privateFrameworksPath]
+          stringByAppendingPathComponent:@"Sparkle.framework"];
+
+  VLOG(0) << "SparkleGlue: Looking for Sparkle framework at: "
+          << base::SysNSStringToUTF8(sparkle_path);
+
+  NSBundle* sparkle_bundle = [NSBundle bundleWithPath:sparkle_path];
+  if (!sparkle_bundle) {
+    VLOG(0) << "SparkleGlue: Sparkle framework not found at: "
+            << base::SysNSStringToUTF8(sparkle_path);
+    return NO;
+  }
+
+  VLOG(0) << "SparkleGlue: Found Sparkle bundle, attempting to load";
+  if (![sparkle_bundle load]) {
+    VLOG(0) << "SparkleGlue: Failed to load Sparkle framework";
+    return NO;
+  }
+
+  VLOG(0) << "SparkleGlue: Successfully loaded Sparkle framework";
+
+  // Get SUUpdater class and create shared instance
+  Class updater_class = [sparkle_bundle classNamed:@"SUUpdater"];
+  if (!updater_class) {
+    VLOG(0) << "SparkleGlue: SUUpdater class not found in Sparkle framework";
+    return NO;
+  }
+
+  VLOG(0) << "SparkleGlue: Found SUUpdater class, creating shared instance";
+  _updater = [updater_class sharedUpdater];
+  if (!_updater) {
+    VLOG(0) << "SparkleGlue: Failed to get SUUpdater shared instance";
+    return NO;
+  }
+
+  VLOG(0) << "SparkleGlue: Successfully created SUUpdater instance";
+  return YES;
+}
+
+- (void)registerWithSparkle {
+  if (_registered || !_updater) {
+    VLOG(0) << "SparkleGlue: Already registered or no updater available";
+    return;
+  }
+
+  VLOG(0) << "SparkleGlue: Registering with Sparkle updater";
+
+  _registered = YES;
+
+  // Configure updater
+  [_updater setDelegate:self];
+  [_updater setUpdateCheckInterval:kUpdateCheckIntervalInSec];
+  [_updater setAutomaticallyChecksForUpdates:YES];
+  [_updater setAutomaticallyDownloadsUpdates:YES];
+
+  // Set feed URL
+  NSString* feedURL = GetUpdateFeedURL();
+  VLOG(0) << "SparkleGlue: Update feed URL: " << base::SysNSStringToUTF8(feedURL);
+
+  VLOG(0) << "SparkleGlue: Successfully registered with Sparkle updater";
+  VLOG(0) << "SparkleGlue: Update check interval: " << kUpdateCheckIntervalInSec << " seconds";
+  VLOG(0) << "SparkleGlue: Automatic checks enabled: YES";
+  VLOG(0) << "SparkleGlue: Automatic downloads enabled: YES";
+}
+
+- (void)checkForUpdates {
+  if (!_registered || !_updater) {
+    VLOG(0) << "Updater not registered";
+    return;
+  }
+
+  VLOG(1) << "Manually checking for updates";
+  [_updater checkForUpdatesInBackground];
+}
+
+- (BOOL)isUpdateCheckEnabled {
+  return _registered && _updater != nil;
+}
+
+- (BOOL)isOnReadOnlyFilesystem {
+  const char* appPathC = _appPath.fileSystemRepresentation;
+  struct statfs statfsBuf;
+
+  if (statfs(appPathC, &statfsBuf) != 0) {
+    PLOG(ERROR) << "statfs failed";
+    return NO;
+  }
+
+  return (statfsBuf.f_flags & MNT_RDONLY) != 0;
+}
+
+- (void)setVersionUpdater:(SparkleVersionUpdater*)updater {
+  VLOG(0) << "SparkleGlue: Setting version updater: " << updater;
+  _versionUpdater = updater;
+}
+
+#pragma mark - SUUpdaterDelegate
+
+- (NSString*)feedURLStringForUpdater:(SUUpdater*)updater {
+  NSString* feedURL = GetUpdateFeedURL();
+  VLOG(0) << "SparkleGlue: Delegate requested feed URL: " << base::SysNSStringToUTF8(feedURL);
+  return feedURL;
+}
+
+- (void)updater:(SUUpdater*)updater didFinishLoadingAppcast:(SUAppcast*)appcast {
+  VLOG(0) << "SparkleGlue: Finished loading appcast";
+  // Notify version updater that we're still checking
+  if (_versionUpdater) {
+    _versionUpdater->OnSparkleStatusChange(kSparkleStatusChecking);
+  }
+}
+
+- (void)updater:(SUUpdater*)updater didFindValidUpdate:(SUAppcastItem*)item {
+  VLOG(0) << "SparkleGlue: Found valid update";
+  if (_versionUpdater) {
+    _versionUpdater->OnSparkleStatusChange(kSparkleStatusUpdateFound);
+  }
+}
+
+- (void)updaterDidNotFindUpdate:(SUUpdater*)updater {
+  VLOG(0) << "SparkleGlue: No update found";
+  if (_versionUpdater) {
+    _versionUpdater->OnSparkleStatusChange(kSparkleStatusNoUpdate);
+  }
+}
+
+- (void)updater:(SUUpdater*)updater willInstallUpdate:(SUAppcastItem*)item {
+  VLOG(0) << "SparkleGlue: Will install update";
+  if (_versionUpdater) {
+    _versionUpdater->OnSparkleStatusChange(kSparkleStatusReadyToInstall);
+  }
+}
+
+- (void)updater:(SUUpdater*)updater didAbortWithError:(NSError*)error {
+  VLOG(0) << "SparkleGlue: Update aborted with error: " << base::SysNSStringToUTF8([error localizedDescription]);
+
+  // Check if this is actually an error or just "no update needed"
+  NSString* errorDesc = [error localizedDescription];
+  if ([errorDesc containsString:@"up to date"] || [errorDesc containsString:@"You're up to date"]) {
+    // This is not really an error, it means no update is needed
+    if (_versionUpdater) {
+      _versionUpdater->OnSparkleStatusChange(kSparkleStatusNoUpdate);
+    }
+  } else {
+    // This is a real error
+    if (_versionUpdater) {
+      _versionUpdater->OnSparkleStatusChange(kSparkleStatusError, base::SysNSStringToUTF8(errorDesc));
+    }
+  }
+}
+
+@end
+
+namespace sparkle_glue {
+
+bool SparkleEnabled() {
+  bool enabled = [SparkleGlue sharedSparkleGlue] != nil;
+  VLOG(0) << "SparkleGlue: Sparkle enabled: " << (enabled ? "YES" : "NO");
+  return enabled;
+}
+
+}  // namespace sparkle_glue
\ No newline at end of file
diff --git a/chrome/browser/mac/su_updater.h b/chrome/browser/mac/su_updater.h
new file mode 100644
index 0000000000000..53947090d7760
--- /dev/null
+++ b/chrome/browser/mac/su_updater.h
@@ -0,0 +1,38 @@
+// Copyright 2024 Nxtscape Browser Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#ifndef CHROME_BROWSER_MAC_SU_UPDATER_H_
+#define CHROME_BROWSER_MAC_SU_UPDATER_H_
+
+#import <Foundation/Foundation.h>
+
+// Forward declarations for Sparkle framework classes
+@class SUAppcast;
+@class SUAppcastItem;
+
+@interface SUUpdater : NSObject
+
++ (SUUpdater*)sharedUpdater;
+
+- (void)setDelegate:(id)delegate;
+- (void)setAutomaticallyChecksForUpdates:(BOOL)enable;
+- (void)setAutomaticallyDownloadsUpdates:(BOOL)enable;
+- (void)setUpdateCheckInterval:(NSTimeInterval)interval;
+- (void)checkForUpdatesInBackground;
+- (void)checkForUpdates:(id)sender;
+
+@property BOOL automaticallyDownloadsUpdates;
+
+@end
+
+// SUUpdaterDelegate protocol (partial)
+@protocol SUUpdaterDelegate <NSObject>
+@optional
+- (NSString*)feedURLStringForUpdater:(SUUpdater*)updater;
+- (void)updater:(SUUpdater*)updater didFinishLoadingAppcast:(SUAppcast*)appcast;
+- (void)updater:(SUUpdater*)updater didFindValidUpdate:(SUAppcastItem*)item;
+- (void)updaterDidNotFindUpdate:(SUUpdater*)updater;
+@end
+
+#endif  // CHROME_BROWSER_MAC_SU_UPDATER_H_
\ No newline at end of file
diff --git a/chrome/browser/sparkle_buildflags.gni b/chrome/browser/sparkle_buildflags.gni
new file mode 100644
index 0000000000000..984f9ab75b1fa
--- /dev/null
+++ b/chrome/browser/sparkle_buildflags.gni
@@ -0,0 +1,21 @@
+ # Copyright 2024 Nxtscape Browser Authors. All rights reserved.
+# Use of this source code is governed by a BSD-style license that can be
+# found in the LICENSE file.
+
+# Copyright 2024 Nxtscape Browser Authors. All rights reserved.
+# Use of this source code is governed by a BSD-style license that can be
+# found in the LICENSE file.
+
+import("//build/config/features.gni")
+
+declare_args() {
+  # Enable Sparkle updater for macOS builds
+  # enable_sparkle = is_mac && !is_component_build && is_official_build
+  enable_sparkle = is_mac
+
+  # Path to Sparkle framework
+  sparkle_framework_path = "//third_party/sparkle/Sparkle.framework"
+
+  # Build Sparkle from source (if false, use prebuilt framework)
+  build_sparkle = false
+}
\ No newline at end of file
diff --git a/chrome/browser/ui/BUILD.gn b/chrome/browser/ui/BUILD.gn
index 93096ad92c1a3..5accc0ef01f89 100644
--- a/chrome/browser/ui/BUILD.gn
+++ b/chrome/browser/ui/BUILD.gn
@@ -3435,6 +3435,8 @@ static_library("ui") {
       "views/frame/native_browser_frame_factory_mac.mm",
       "views/tab_contents/chrome_web_contents_view_delegate_views_mac.h",
       "views/tab_contents/chrome_web_contents_view_delegate_views_mac.mm",
+      "webui/help/sparkle_version_updater_mac.h",
+      "webui/help/sparkle_version_updater_mac.mm",
       "webui/help/version_updater_mac.mm",
       "webui/settings/mac_system_settings_handler.cc",
       "webui/settings/mac_system_settings_handler.h",
@@ -3453,6 +3455,7 @@ static_library("ui") {
     allow_circular_includes_from += [ "//chrome/browser/apps/app_shim" ]
 
     deps += [
+      "//chrome/browser:sparkle_buildflags",
       "//chrome/browser/apps/app_shim",
       "//chrome/browser/enterprise/connectors/device_trust/key_management/core/mac",
       "//chrome/browser/updater:browser_updater_client",
diff --git a/chrome/browser/ui/webui/help/sparkle_version_updater_mac.h b/chrome/browser/ui/webui/help/sparkle_version_updater_mac.h
new file mode 100644
index 0000000000000..c54fb05d1e984
--- /dev/null
+++ b/chrome/browser/ui/webui/help/sparkle_version_updater_mac.h
@@ -0,0 +1,50 @@
+// Copyright 2024 Nxtscape Browser Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#ifndef CHROME_BROWSER_UI_WEBUI_HELP_SPARKLE_VERSION_UPDATER_MAC_H_
+#define CHROME_BROWSER_UI_WEBUI_HELP_SPARKLE_VERSION_UPDATER_MAC_H_
+
+#include "chrome/browser/ui/webui/help/version_updater.h"
+#include "chrome/browser/mac/sparkle_glue.h"
+
+#if defined(__OBJC__)
+@class NSNotification;
+#else
+class NSNotification;
+#endif
+
+// Enum for Sparkle update status
+enum SparkleUpdateStatus {
+  kSparkleStatusChecking,
+  kSparkleStatusNoUpdate,
+  kSparkleStatusUpdateFound,
+  kSparkleStatusDownloading,
+  kSparkleStatusReadyToInstall,
+  kSparkleStatusError
+};
+
+// SparkleVersionUpdater is the VersionUpdater implementation for macOS
+// that uses the Sparkle framework for updates.
+class SparkleVersionUpdater : public VersionUpdater {
+ public:
+  SparkleVersionUpdater();
+  SparkleVersionUpdater(const SparkleVersionUpdater&) = delete;
+  SparkleVersionUpdater& operator=(const SparkleVersionUpdater&) = delete;
+  ~SparkleVersionUpdater() override;
+
+  // VersionUpdater implementation.
+  void CheckForUpdate(StatusCallback status_callback,
+                      PromoteCallback promote_callback) override;
+  void PromoteUpdater() override;
+
+  // Called by SparkleGlue to notify of status changes
+  void OnSparkleStatusChange(SparkleUpdateStatus status, const std::string& error_message = "");
+
+ private:
+  void UpdateStatus(SparkleUpdateStatus status, const std::string& error_message = "");
+
+  StatusCallback status_callback_;
+};
+
+#endif  // CHROME_BROWSER_UI_WEBUI_HELP_SPARKLE_VERSION_UPDATER_MAC_H_
\ No newline at end of file
diff --git a/chrome/browser/ui/webui/help/sparkle_version_updater_mac.mm b/chrome/browser/ui/webui/help/sparkle_version_updater_mac.mm
new file mode 100644
index 0000000000000..8f7857f4d0e40
--- /dev/null
+++ b/chrome/browser/ui/webui/help/sparkle_version_updater_mac.mm
@@ -0,0 +1,89 @@
+// Copyright 2024 Nxtscape Browser Authors. All rights reserved.
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#include "chrome/browser/ui/webui/help/sparkle_version_updater_mac.h"
+
+#include "base/logging.h"
+#include "base/strings/utf_string_conversions.h"
+#include "chrome/browser/mac/sparkle_glue.h"
+#include "chrome/grit/generated_resources.h"
+#include "ui/base/l10n/l10n_util.h"
+
+SparkleVersionUpdater::SparkleVersionUpdater() = default;
+SparkleVersionUpdater::~SparkleVersionUpdater() = default;
+
+void SparkleVersionUpdater::CheckForUpdate(StatusCallback status_callback,
+                                          PromoteCallback promote_callback) {
+  VLOG(0) << "SparkleVersionUpdater: CheckForUpdate called";
+  status_callback_ = std::move(status_callback);
+
+  SparkleGlue* sparkle = [SparkleGlue sharedSparkleGlue];
+  if (!sparkle || ![sparkle isUpdateCheckEnabled]) {
+    VLOG(0) << "SparkleVersionUpdater: Sparkle updater not available or disabled";
+    UpdateStatus(kSparkleStatusError, "Sparkle updater not available");
+    return;
+  }
+
+  VLOG(0) << "SparkleVersionUpdater: Starting update check";
+  // Start checking for updates
+  UpdateStatus(kSparkleStatusChecking);
+
+  // Set this updater as the current one so SparkleGlue can notify us
+  [sparkle setVersionUpdater:this];
+
+  [sparkle checkForUpdates];
+}
+
+void SparkleVersionUpdater::PromoteUpdater() {
+  // Sparkle doesn't require promotion like Google's updater
+  // This is a no-op for Sparkle
+  VLOG(0) << "SparkleVersionUpdater: PromoteUpdater called - not needed for Sparkle";
+}
+
+void SparkleVersionUpdater::OnSparkleStatusChange(SparkleUpdateStatus status, const std::string& error_message) {
+  VLOG(0) << "SparkleVersionUpdater: Status change received: " << static_cast<int>(status);
+  UpdateStatus(status, error_message);
+}
+
+void SparkleVersionUpdater::UpdateStatus(SparkleUpdateStatus status, const std::string& error_message) {
+  if (status_callback_.is_null()) {
+    VLOG(0) << "SparkleVersionUpdater: No status callback available";
+    return;
+  }
+
+  Status update_status = CHECKING;
+  std::u16string message;
+
+  switch (status) {
+    case kSparkleStatusChecking:
+      VLOG(0) << "SparkleVersionUpdater: Status - Checking for updates";
+      update_status = CHECKING;
+      break;
+    case kSparkleStatusNoUpdate:
+      VLOG(0) << "SparkleVersionUpdater: Status - No update available";
+      update_status = UPDATED;
+      break;
+    case kSparkleStatusUpdateFound:
+      VLOG(0) << "SparkleVersionUpdater: Status - Update found";
+      update_status = UPDATING;
+      break;
+    case kSparkleStatusDownloading:
+      VLOG(0) << "SparkleVersionUpdater: Status - Downloading update";
+      update_status = UPDATING;
+      break;
+    case kSparkleStatusReadyToInstall:
+      VLOG(0) << "SparkleVersionUpdater: Status - Ready to install";
+      update_status = NEARLY_UPDATED;
+      break;
+    case kSparkleStatusError:
+      VLOG(0) << "SparkleVersionUpdater: Status - Error: " << error_message;
+      update_status = FAILED;
+      message = base::UTF8ToUTF16(error_message);
+      break;
+  }
+
+  VLOG(0) << "SparkleVersionUpdater: Calling status callback with status: " << static_cast<int>(update_status);
+  status_callback_.Run(update_status, 0, false, false, std::string(), 0,
+                       message);
+}
\ No newline at end of file
diff --git a/chrome/browser/ui/webui/help/version_updater_mac.mm b/chrome/browser/ui/webui/help/version_updater_mac.mm
index 992157e28e8f5..4c5949b1d266a 100644
--- a/chrome/browser/ui/webui/help/version_updater_mac.mm
+++ b/chrome/browser/ui/webui/help/version_updater_mac.mm
@@ -6,6 +6,15 @@
 
 #import <Foundation/Foundation.h>
 
+// Include Sparkle updater if available
+#include "base/command_line.h"
+#include "chrome/browser/sparkle_buildflags.h"
+
+#if BUILDFLAG(ENABLE_SPARKLE)
+#include "chrome/browser/ui/webui/help/sparkle_version_updater_mac.h"
+#include "chrome/browser/mac/sparkle_glue.h"
+#endif
+
 #include <algorithm>
 #include <memory>
 #include <string>
@@ -47,6 +56,8 @@ int GetDownloadProgress(int64_t downloaded_bytes, int64_t total_bytes) {
 
 void UpdateStatus(VersionUpdater::StatusCallback status_callback,
                   const updater::UpdateService::UpdateState& update_state) {
+  VLOG(0) << "VersionUpdaterMac: UpdateStatus called with state: " << static_cast<int>(update_state.state);
+
   VersionUpdater::Status status = VersionUpdater::Status::CHECKING;
   int progress = 0;
   std::string version;
@@ -54,38 +65,48 @@ void UpdateStatus(VersionUpdater::StatusCallback status_callback,
 
   switch (update_state.state) {
     case updater::UpdateService::UpdateState::State::kCheckingForUpdates:
+      VLOG(0) << "VersionUpdaterMac: Checking for updates";
       [[fallthrough]];
     case updater::UpdateService::UpdateState::State::kUpdateAvailable:
+      VLOG(0) << "VersionUpdaterMac: Update available";
       status = VersionUpdater::Status::CHECKING;
       break;
     case updater::UpdateService::UpdateState::State::kDownloading:
       progress = GetDownloadProgress(update_state.downloaded_bytes,
                                      update_state.total_bytes);
+      VLOG(0) << "VersionUpdaterMac: Downloading update, progress: " << progress << "%";
       [[fallthrough]];
     case updater::UpdateService::UpdateState::State::kInstalling:
+      VLOG(0) << "VersionUpdaterMac: Installing update";
       status = VersionUpdater::Status::UPDATING;
       break;
     case updater::UpdateService::UpdateState::State::kUpdated:
+      VLOG(0) << "VersionUpdaterMac: Update completed";
       status = VersionUpdater::Status::NEARLY_UPDATED;
       break;
     case updater::UpdateService::UpdateState::State::kNoUpdate:
+      VLOG(0) << "VersionUpdaterMac: No update available";
       status = UpgradeDetector::GetInstance()->is_upgrade_available()
                    ? VersionUpdater::Status::NEARLY_UPDATED
                    : VersionUpdater::Status::UPDATED;
       break;
     case updater::UpdateService::UpdateState::State::kUpdateError:
+      VLOG(0) << "VersionUpdaterMac: Update error, code: " << update_state.error_code;
       switch (update_state.error_code) {
         case updater::GOOPDATE_E_APP_UPDATE_DISABLED_BY_POLICY:
+          VLOG(0) << "VersionUpdaterMac: Updates disabled by policy";
           status = VersionUpdater::Status::DISABLED_BY_ADMIN;
           err_message =
               l10n_util::GetStringUTF16(IDS_UPGRADE_DISABLED_BY_POLICY);
           break;
         case updater::GOOPDATE_E_APP_UPDATE_DISABLED_BY_POLICY_MANUAL:
+          VLOG(0) << "VersionUpdaterMac: Manual updates disabled by policy";
           status = VersionUpdater::Status::DISABLED_BY_ADMIN;
           err_message =
               l10n_util::GetStringUTF16(IDS_UPGRADE_DISABLED_BY_POLICY_MANUAL);
           break;
         default:
+          VLOG(0) << "VersionUpdaterMac: Generic update error";
           status = VersionUpdater::Status::FAILED;
           err_message = l10n_util::GetStringFUTF16(
               IDS_ABOUT_BOX_ERROR_DURING_UPDATE_CHECK,
@@ -98,11 +119,14 @@ void UpdateStatus(VersionUpdater::StatusCallback status_callback,
       }
       break;
     case updater::UpdateService::UpdateState::State::kNotStarted:
+      VLOG(0) << "VersionUpdaterMac: Update not started";
       [[fallthrough]];
     case updater::UpdateService::UpdateState::State::kUnknown:
+      VLOG(0) << "VersionUpdaterMac: Unknown update state";
       return;
   }
 
+  VLOG(0) << "VersionUpdaterMac: Calling status callback with status: " << static_cast<int>(status);
   status_callback.Run(status, progress, false, false, version, 0, err_message);
 }
 
@@ -118,9 +142,11 @@ class VersionUpdaterMac : public VersionUpdater {
   // VersionUpdater implementation.
   void CheckForUpdate(StatusCallback status_callback,
                       PromoteCallback promote_callback) override {
+    VLOG(0) << "VersionUpdaterMac: Checking for updates";
     EnsureUpdater(
         base::BindOnce(
             [](PromoteCallback prompt) {
+              VLOG(0) << "VersionUpdaterMac: Promote callback - enabling promotion";
               prompt.Run(PromotionState::PROMOTE_ENABLED);
             },
             promote_callback),
@@ -128,6 +154,7 @@ class VersionUpdaterMac : public VersionUpdater {
             [](base::RepeatingCallback<void(
                    const updater::UpdateService::UpdateState&)>
                    status_callback) {
+              VLOG(0) << "VersionUpdaterMac: Starting update check process";
               base::ThreadPool::PostTaskAndReplyWithResult(
                   FROM_HERE, {base::MayBlock()},
                   base::BindOnce(&GetBrowserUpdaterScope),
@@ -136,6 +163,7 @@ class VersionUpdaterMac : public VersionUpdater {
                              const updater::UpdateService::UpdateState&)>
                              status_callback,
                          updater::UpdaterScope scope) {
+                        VLOG(0) << "VersionUpdaterMac: Creating browser updater client for scope: " << static_cast<int>(scope);
                         BrowserUpdaterClient::Create(scope)->CheckForUpdate(
                             status_callback);
                       },
@@ -143,12 +171,30 @@ class VersionUpdaterMac : public VersionUpdater {
             },
             base::BindRepeating(&UpdateStatus, status_callback)));
   }
-  void PromoteUpdater() override { SetupSystemUpdater(); }
+  void PromoteUpdater() override {
+    VLOG(0) << "VersionUpdaterMac: Promoting updater";
+    SetupSystemUpdater();
+  }
 };
 
 }  // namespace
 
 std::unique_ptr<VersionUpdater> VersionUpdater::Create(
     content::WebContents* /* web_contents */) {
+#if BUILDFLAG(ENABLE_SPARKLE)
+  VLOG(0) << "VersionUpdater: Checking if Sparkle updater is available";
+  // Use Sparkle updater if it's enabled
+  if (sparkle_glue::SparkleEnabled()) {
+    VLOG(0) << "VersionUpdater: Using Sparkle updater";
+    return base::WrapUnique(new SparkleVersionUpdater());
+  } else {
+    VLOG(0) << "VersionUpdater: Sparkle not available, falling back to default updater";
+  }
+#else
+  VLOG(0) << "VersionUpdater: Sparkle not compiled in, using default updater";
+#endif
+
+  // Otherwise use the default Chromium updater
+  VLOG(0) << "VersionUpdater: Using default Chromium updater";
   return base::WrapUnique(new VersionUpdaterMac());
 }
diff --git a/third_party/sparkle/BUILD.gn b/third_party/sparkle/BUILD.gn
new file mode 100644
index 0000000000000..5c09b44984519
--- /dev/null
+++ b/third_party/sparkle/BUILD.gn
@@ -0,0 +1,50 @@
+# Copyright 2024 The Chromium Authors
+# Use of this source code is governed by a BSD-style license that can be
+# found in the LICENSE file.
+
+import("//build/config/mac/mac_sdk.gni")
+
+assert(is_mac)
+
+# Bundle data for Sparkle.framework
+bundle_data("sparkle_framework_bundle_data") {
+  sources = [ "Sparkle.framework" ]
+  outputs = [ "{{bundle_contents_dir}}/Frameworks/{{source_file_part}}" ]
+}
+
+# Main Sparkle framework target
+group("sparkle") {
+  public_deps = [ ":sparkle_framework_bundle_data" ]
+}
+
+# Configuration for including Sparkle headers
+config("sparkle_config") {
+  framework_dirs = [ "$root_out_dir" ]
+  
+  # Add the framework search path
+  ldflags = [
+    "-F",
+    rebase_path(".", root_build_dir),
+    "-framework",
+    "Sparkle",
+    "-weak_framework",
+    "Sparkle",
+  ]
+}
+
+# Target for apps that want to use Sparkle
+group("sparkle_framework") {
+  public_deps = [ ":sparkle" ]
+  
+  public_configs = [ ":sparkle_config" ]
+}
+
+# Resources that might be needed by Sparkle
+bundle_data("sparkle_resources") {
+  sources = [
+    "Sparkle.framework/Versions/B/Resources/Autoupdate.app",
+    "Sparkle.framework/Versions/B/Resources/Updater.app",
+  ]
+  
+  outputs = [ "{{bundle_contents_dir}}/Frameworks/Sparkle.framework/Resources/{{source_file_part}}" ]
+} 
\ No newline at end of file
-- 
2.49.0

